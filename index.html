<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<title>ğŸ† Balsavimo rezultatai</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#141e30,#243b55);
  color:white;
  text-align:center;
  margin:0;
  padding:20px;
}

h2{margin-bottom:5px;}

#lastUpdate,#countdown{
  font-size:14px;
  opacity:0.8;
}

#aiComment{
  max-width:900px;
  margin:20px auto;
  padding:15px 20px;
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(10px);
  border-radius:12px;
  font-size:15px;
  line-height:1.5;
  min-height:52px;
  transition:0.3s;
}

.stats{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
  gap:20px;
  max-width:1000px;
  margin:30px auto;
}

.statCard{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(12px);
  padding:25px 15px;
  border-radius:15px;
  transition:0.3s;
  border:1px solid rgba(255,255,255,0.1);
}

.statCard.big{
  background:linear-gradient(135deg,#00c853,#4caf50);
  font-weight:bold;
}

.statNumber{
  font-size:28px;
  font-weight:bold;
  margin-bottom:8px;
}

.statLabel{
  font-size:13px;
  opacity:0.8;
}

table{
  width:95%;
  max-width:1000px;
  margin:auto;
  border-collapse:collapse;
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(10px);
  border-radius:10px;
  overflow:hidden;
}

th{background:rgba(255,255,255,0.15);padding:12px;}
td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);}
tr:hover{background:rgba(255,255,255,0.1);}

img{
  width:45px;
  height:45px;
  border-radius:50%;
  vertical-align:middle;
  margin-right:10px;
  object-fit:cover;
}

.nameCell{text-align:left;}

.progressBar{
  width:100%;
  height:8px;
  background:rgba(255,255,255,0.2);
  border-radius:5px;
  overflow:hidden;
  margin-bottom:4px;
}

.progressFill{
  height:100%;
  background:linear-gradient(90deg,#81C784,#4CAF50);
  transition:width 0.5s ease;
}

.firstPlace{
  background:linear-gradient(90deg,rgba(255,215,0,0.15),transparent);
}
.secondPlace{ background:rgba(192,192,192,0.1); }
.thirdPlace{ background:rgba(205,127,50,0.1); }

.gainUp{color:#81C784;font-weight:bold;}
.gainDown{color:#EF9A9A;font-weight:bold;}

canvas{
  max-width:900px;
  margin:40px auto;
}
</style>
</head>

<body>

<h2>ğŸ† Balsavimo rezultatai</h2>
<div id="lastUpdate"></div>
<div id="countdown"></div>

<div id="aiComment">ğŸ¤– AI stebi situacijÄ…...</div>

<div class="stats">
  <div class="statCard big">
    <div class="statNumber" id="totalVotes">0</div>
    <div class="statLabel">IÅ¡ viso balsÅ³</div>
  </div>
  <div class="statCard">
    <div class="statNumber" id="votesPerMinute">0</div>
    <div class="statLabel">âš¡ BalsÅ³ per minutÄ™</div>
  </div>
  <div class="statCard">
    <div class="statNumber" id="leaderGap">0</div>
    <div class="statLabel">ğŸ¥‡ AtotrÅ«kis</div>
  </div>
  <div class="statCard">
    <div class="statNumber" id="leaderPercent">0%</div>
    <div class="statLabel">ğŸ¥‡ Lyderio dalis</div>
  </div>
</div>

<table id="tbl"></table>
<canvas id="pieChart"></canvas>

<script>
let previousVotes = {};
let previousRanks = {};
let previousLeader = null;
let previousGap = null;
let commentMemory = "";

let refreshInterval = 5;
let timeLeft = refreshInterval;
let pieChart;

function cleanName(name){
  return name.replace(/\/+/g,'');
}

function generateAIComment(sorted, gains){

  if(sorted.length < 2) return "DuomenÅ³ nepakanka.";

  const leader = sorted[0];
  const second = sorted[1];

  const leaderName = cleanName(leader.name);
  const secondName = cleanName(second.name);

  const gap = leader.votes - second.votes;
  const gapChange = previousGap !== null ? gap - previousGap : 0;

  let comments = [];

  // ğŸ”„ Aplenkti dalyviai
  sorted.forEach((c,i)=>{
    const name = cleanName(c.name);
    if(previousRanks[name] != null && previousRanks[name] > i){
      comments.push(`ğŸš€ ${name} kyla Ä¯ ${i+1} vietÄ…!`);
    }
  });

  // ğŸ Lyderio pasikeitimas
  if(previousLeader && previousLeader !== leaderName){
    comments.push(`ğŸš¨ Naujas lyderis â€“ ${leaderName}!`);
  }

  // ğŸ”¥ FiniÅ¡o tiesioji
  if(gap < 50){
    comments.push(`ğŸ”¥ Tik ${gap} balsÅ³ skiria ${leaderName} ir ${secondName}! Drama!`);
  }

  // ğŸ“ˆ AtotrÅ«kio pokytis
  if(gapChange > 30){
    comments.push(`ğŸ“ˆ ${leaderName} didina pranaÅ¡umÄ… (+${gapChange}).`);
  }
  if(gapChange < -30){
    comments.push(`ğŸ“‰ ${secondName} agresyviai maÅ¾ina atsilikimÄ….`);
  }

  // ğŸš€ GreiÄiausiai augantis
  let fastest = gains.sort((a,b)=>b.gain-a.gain)[0];
  if(fastest && fastest.gain > 20){
    comments.push(`âš¡ ${fastest.name} demonstruoja stipriausiÄ… augimÄ… (+${fastest.gain}).`);
  }

  // ğŸ§Š Jei nieko ypatingo
  if(comments.length === 0){
    comments.push(`${leaderName} iÅ¡lieka priekyje, situacija stabili.`);
  }

  let newComment = comments[Math.floor(Math.random()*comments.length)];

  if(newComment === commentMemory && comments.length > 1){
    newComment = comments.find(c=>c!==commentMemory);
  }

  commentMemory = newComment;
  previousLeader = leaderName;
  previousGap = gap;

  return newComment;
}

function fetchData(){
  fetch("https://www.lrt.lt/api/v1/daily-question/2417?t="+Date.now(),{cache:"no-store"})
  .then(res=>res.json())
  .then(data=>{

    const table=document.getElementById("tbl");
    table.innerHTML=`
      <tr>
        <th>Dalyvis</th>
        <th>Balsai</th>
        <th>Pokytis</th>
        <th>%</th>
        <th>Skirtumas</th>
      </tr>`;

    let sorted=data.choices.sort((a,b)=>b.votes-a.votes);
    let topVotes=sorted[0]?.votes||0;
    let totalVotes=0;
    let totalGain=0;
    let gains=[];

    sorted.forEach((c,index)=>{
      let name=cleanName(c.name);
      let oldVotes=previousVotes[name]??c.votes;
      let gain=c.votes-oldVotes;

      gains.push({name:name,gain:gain});

      totalGain+=gain;
      totalVotes+=c.votes;

      let diff=index===0?0:topVotes-c.votes;

      table.innerHTML+=`
        <tr class="${index===0?'firstPlace':index===1?'secondPlace':index===2?'thirdPlace':''}">
          <td class="nameCell">
            <img src="${c.image||'https://via.placeholder.com/45'}">
            <strong>${index+1}. ${name}</strong><br>
            <small>${c.song||''}</small>
          </td>
          <td>${c.votes.toLocaleString()}</td>
          <td class="${gain>=0?'gainUp':'gainDown'}">${gain>=0?'+':''}${gain}</td>
          <td>
            <div class="progressBar">
              <div class="progressFill" style="width:${c.percentage}%"></div>
            </div>
            ${c.percentage}%
          </td>
          <td>${diff.toLocaleString()}</td>
        </tr>`;

      previousVotes[name]=c.votes;
      previousRanks[name]=index;
    });

    document.getElementById("totalVotes").innerHTML=totalVotes.toLocaleString();
    document.getElementById("votesPerMinute").innerHTML=
      Math.round((totalGain/refreshInterval)*60).toLocaleString();
    document.getElementById("leaderGap").innerHTML=
      (sorted[1]? (sorted[0].votes-sorted[1].votes).toLocaleString():0);
    document.getElementById("leaderPercent").innerHTML =
      totalVotes ? Math.round((sorted[0].votes/totalVotes)*100)+"%" : "0%";

    document.getElementById("aiComment").innerText =
      generateAIComment(sorted,gains);

    updatePieChart(sorted.slice(0,5));

    document.getElementById("lastUpdate").innerHTML=
      "Atsinaujino: "+new Date().toLocaleTimeString();

    timeLeft=refreshInterval;
  });
}

function updatePieChart(top5){
  const ctx=document.getElementById('pieChart').getContext('2d');
  let labels=top5.map(c=>cleanName(c.name));
  let votes=top5.map(c=>c.votes);

  if(pieChart) pieChart.destroy();

  pieChart=new Chart(ctx,{
    type:'pie',
    data:{
      labels:labels,
      datasets:[{
        data:votes,
        backgroundColor:[
          '#F6DFA6','#D9D9D9','#D7B49E','#A5D6A7','#B2DFDB'
        ]
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:'bottom'}}
    }
  });
}

setInterval(()=>{
  timeLeft--;
  if(timeLeft<=0) fetchData();
  document.getElementById("countdown").innerHTML=
    "Atnaujinama po: "+timeLeft+" s";
},1000);

fetchData();
</script>

</body>
</html>
