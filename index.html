<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<title>üèÜ Balsavimo rezultatai</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* VISAS TAVO CSS PALIKTAS NEKEISTAS */
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#141e30,#243b55);
  color:white;
  text-align:center;
  margin:0;
  padding:20px;
}
h2{margin-bottom:5px;}
#lastUpdate,#countdown{font-size:14px;opacity:0.8;}
.stats{display:grid;grid-template-columns: repeat(auto-fit,minmax(160px,1fr));gap:20px;max-width:1000px;margin:30px auto;}
.statCard{background:rgba(255,255,255,0.08);backdrop-filter:blur(12px);padding:25px 15px;border-radius:15px;transition:0.3s;border:1px solid rgba(255,255,255,0.1);}
.statCard:hover{transform:translateY(-5px);background:rgba(255,255,255,0.12);}
.statCard.big{background:linear-gradient(135deg,#00c853,#4caf50);color:white;font-weight:bold;}
.statNumber{font-size:28px;font-weight:bold;margin-bottom:8px;}
.statLabel{font-size:13px;opacity:0.8;letter-spacing:0.5px;}
table{width:95%;max-width:1000px;margin:auto;border-collapse:collapse;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);border-radius:10px;overflow:hidden;}
th{background:rgba(255,255,255,0.15);padding:12px;}
td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);}
tr:hover{background:rgba(255,255,255,0.1);}
img{width:45px;height:45px;border-radius:50%;vertical-align:middle;margin-right:10px;object-fit:cover;}
.nameCell{text-align:left;}
.progressBar{width:100%;height:8px;background:rgba(255,255,255,0.2);border-radius:5px;overflow:hidden;margin-bottom:4px;}
.progressFill{height:100%;background:linear-gradient(90deg,#81C784,#4CAF50);transition:width 0.5s ease;}
.firstPlace{background:linear-gradient(90deg,rgba(255,215,0,0.15),transparent);}
.secondPlace{background:rgba(192,192,192,0.1);}
.thirdPlace{background:rgba(205,127,50,0.1);}
.gainUp{color:#81C784;font-weight:bold;}
.gainDown{color:#EF9A9A;font-weight:bold;}
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#E8C97A;color:black;padding:10px 20px;border-radius:20px;display:none;font-weight:bold;z-index:1000;}
canvas{max-width:900px;margin:40px auto;}
</style>
</head>

<body>

<h2>üèÜ Balsavimo rezultatai</h2>
<div id="lastUpdate"></div>
<div id="countdown"></div>

<div class="stats">
  <div class="statCard big">
    <div class="statNumber" id="totalVotes">0</div>
    <div class="statLabel">I≈° viso bals≈≥</div>
  </div>
  <div class="statCard">
    <div class="statNumber" id="votesPerMinute">0</div>
    <div class="statLabel">‚ö° Bals≈≥ per minutƒô</div>
  </div>
  <div class="statCard">
    <div class="statNumber" id="leaderGap">0</div>
    <div class="statLabel">ü•á Atotr≈´kis</div>
  </div>
  <div class="statCard">
    <div class="statNumber" id="fastestGrower">‚Äì</div>
    <div class="statLabel">üöÄ Greiƒçiausiai auga</div>
  </div>
  <div class="statCard">
    <div class="statNumber" id="leaderPercent">0%</div>
    <div class="statLabel">ü•á Lyderio dalis</div>
  </div>
</div>

<table id="tbl"></table>
<canvas id="pieChart"></canvas>
<div id="toast"></div>

<script>
let previousVotes = {};
let previousRanks = {};
let refreshInterval = 5;
let timeLeft = refreshInterval;
let pieChart;

/* üîä BALSO SISTEMA */

let speechEnabled = true;
let speaking = false;

function speak(text){
  if(!speechEnabled) return;
  if(speaking) return;

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "lt-LT";
  utterance.rate = 1;
  utterance.pitch = 1;

  speaking = true;

  utterance.onend = () => {
    speaking = false;
  };

  speechSynthesis.speak(utterance);
}

/* AI KOMENTARAI */

function generateComment(name, gain, rank, previousRank){
  if(gain <= 0) return null;

  const singleVote = [
    `+1 balsas ${name}!`,
    `${name} pasiima dar vienƒÖ balsƒÖ.`,
    `Vienas balsas ${name}.`,
    `${name} +1.`
  ];

  const smallGain = [
    `${name} renka pagreitƒØ!`,
    `${gain} nauji balsai ${name}!`,
    `${name} kyla auk≈°tyn.`,
  ];

  const bigGain = [
    `${name} ≈°auna ƒØ vir≈°≈≥!`,
    `${name} sprogimas!`,
    `${name} ƒØjungƒó turbo re≈æimƒÖ!`
  ];

  const leaderBoost = [
    `Lyderis ${name} stiprina pozicijƒÖ!`,
    `${name} pirmoje vietoje!`
  ];

  const overtake = [
    `${name} aplenkƒó konkurentƒÖ!`,
    `${name} kyla auk≈°tyn lentelƒóje!`
  ];

  if(previousRank !== undefined && rank < previousRank){
    return overtake[Math.floor(Math.random()*overtake.length)];
  }

  if(rank === 0){
    return leaderBoost[Math.floor(Math.random()*leaderBoost.length)];
  }

  if(gain === 1){
    return singleVote[Math.floor(Math.random()*singleVote.length)];
  }

  if(gain >= 5){
    return bigGain[Math.floor(Math.random()*bigGain.length)];
  }

  return smallGain[Math.floor(Math.random()*smallGain.length)];
}

function showToast(text){
  const toast=document.getElementById("toast");
  toast.innerText=text;
  toast.style.display="block";
  speak(text); // üîä automatinis perskaitymas
  setTimeout(()=>toast.style.display="none",3000);
}

/* FETCH */

function fetchData(){
  fetch("https://www.lrt.lt/api/v1/daily-question/2417?t="+Date.now(),{cache:"no-store"})
  .then(res=>res.json())
  .then(data=>{

    const table=document.getElementById("tbl");
    table.innerHTML=`
      <tr>
        <th>Dalyvis</th>
        <th>Balsai</th>
        <th>Pokytis</th>
        <th>%</th>
        <th>Skirtumas</th>
      </tr>`;

    let sorted=data.choices.sort((a,b)=>b.votes-a.votes);
    let topVotes=sorted[0]?.votes||0;

    sorted.forEach((c,index)=>{
      let name=c.name.replace(/\/+/g,'');
      let oldVotes=previousVotes[name]??c.votes;
      let gain=c.votes-oldVotes;

      let previousRank=previousRanks[name];
      let comment=generateComment(name,gain,index,previousRank);
      if(comment) showToast(comment);

      let diff=index===0?0:topVotes-c.votes;

      table.innerHTML+=`
        <tr>
          <td class="nameCell">
            <img src="${c.image||'https://via.placeholder.com/45'}">
            <strong>${index+1}. ${name}</strong>
          </td>
          <td>${c.votes.toLocaleString()}</td>
          <td>${gain>=0?'+':''}${gain}</td>
          <td>${c.percentage}%</td>
          <td>${diff.toLocaleString()}</td>
        </tr>`;

      previousVotes[name]=c.votes;
      previousRanks[name]=index;
    });

    document.getElementById("lastUpdate").innerHTML=
      "Atsinaujino: "+new Date().toLocaleTimeString();

    timeLeft=refreshInterval;
  });
}

setInterval(()=>{
  timeLeft--;
  if(timeLeft<=0) fetchData();
  document.getElementById("countdown").innerHTML=
    "Atnaujinama po: "+timeLeft+" s";
},1000);

fetchData();
</script>

</body>
</html>
