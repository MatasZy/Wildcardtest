<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<title>üèÜ Balsavimo rezultatai</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
#soundBtn{
  position:fixed;
  bottom:20px;
  right:20px;
  padding:12px 20px;
  border:none;
  border-radius:25px;
  background:#E8C97A;
  font-weight:bold;
  cursor:pointer;
  z-index:1001;
}

.playBtn{
  margin-top:6px;
  padding:4px 10px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:#E8C97A;
  font-size:12px;
  font-weight:bold;
}

#videoBackground {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}

#videoBackground iframe {
  width: 100vw;
  height: 100vh;
  pointer-events: none;
}

body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 0;
}

body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#141e30,#243b55);
  color:white;
  text-align:center;
  margin:0;
  padding:20px;
}

.stats{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
  gap:20px;
  max-width:1000px;
  margin:30px auto;
}

.statCard{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(12px);
  padding:25px 15px;
  border-radius:15px;
}

table{
  width:95%;
  max-width:1000px;
  margin:auto;
  border-collapse:collapse;
  background:rgba(255,255,255,0.08);
  border-radius:10px;
  overflow:hidden;
}

th, td{padding:12px;}
th{background:rgba(255,255,255,0.15);}
tr:hover{background:rgba(255,255,255,0.1);}

canvas{max-width:900px;margin:40px auto;}

#toast{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#E8C97A;
  color:black;
  padding:10px 20px;
  border-radius:20px;
  display:none;
  font-weight:bold;
  z-index:1000;
}
</style>
</head>

<body>

<div id="videoBackground">
  <iframe 
    id="bgVideo"
    src="https://www.youtube.com/embed/N1y7G6UQi_0?autoplay=1&mute=1&loop=1&playlist=N1y7G6UQi_0&controls=0&enablejsapi=1"
    frameborder="0"
    allow="autoplay; fullscreen"
    allowfullscreen>
  </iframe>
</div>

<h2>üèÜ Balsavimo rezultatai</h2>
<button id="soundBtn">üîä ƒÆjungti garsƒÖ</button>

<div id="lastUpdate"></div>
<div id="countdown"></div>

<div class="stats">
  <div class="statCard">
    <div id="totalVotes">0</div>
    <div>I≈° viso bals≈≥</div>
  </div>
</div>

<table id="tbl"></table>
<canvas id="pieChart"></canvas>
<div id="toast"></div>

<script>
let previousVotes = {};
let previousRanks = {};
let refreshInterval = 5;
let timeLeft = refreshInterval;
let pieChart;
let player;

/* ===== YouTube ===== */
function onYouTubeIframeAPIReady() {
  player = new YT.Player('bgVideo');
}

function changeBackground(videoId){
  if(player){
    player.loadVideoById(videoId);
    player.unMute();
    player.setVolume(100);
    player.playVideo();
  }
}

document.getElementById("soundBtn").addEventListener("click", function(){
  if(player){
    player.unMute();
    player.setVolume(100);
    player.playVideo();
    this.innerText = "üîà Garsas ƒØjungtas";
  }
});

/* ===== Play Button ===== */
function getPlayButton(name, song){
  const cleanSong = (song || "").toLowerCase();

  if(name.includes("N√∏ra Blu") && cleanSong.includes("hold my own")){
    return `<br><button onclick="changeBackground('N1y7G6UQi_0')" class="playBtn">‚ñ∂ Play</button>`;
  }

  if(name.includes("Grete") && cleanSong.includes("parade")){
    return `<br><button onclick="changeBackground('hgcP25DYLSw')" class="playBtn">‚ñ∂ Play</button>`;
  }

  return "";
}

/* ===== Toast ===== */
function showToast(text){
  const toast=document.getElementById("toast");
  toast.innerText=text;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3000);
}

/* ===== Chart ===== */
function updatePieChart(top5){
  const ctx=document.getElementById('pieChart').getContext('2d');
  let labels=top5.map(c=>c.name);
  let votes=top5.map(c=>c.votes);

  if(pieChart) pieChart.destroy();

  pieChart=new Chart(ctx,{
    type:'pie',
    data:{
      labels:labels,
      datasets:[{
        data:votes
      }]
    }
  });
}

/* ===== Fetch ===== */
function fetchData(){
  fetch("https://www.lrt.lt/api/v1/daily-question/2417?t="+Date.now())
  .then(res=>res.json())
  .then(data=>{

    const table=document.getElementById("tbl");
    table.innerHTML=`
      <tr>
        <th>Dalyvis</th>
        <th>Balsai</th>
      </tr>`;

    let sorted=data.choices.sort((a,b)=>b.votes-a.votes);
    let totalVotes=0;

    sorted.forEach((c,index)=>{
      let name=c.name;
      totalVotes+=c.votes;

      table.innerHTML+=`
        <tr>
          <td>
            <strong>${index+1}. ${name}</strong><br>
            <small>${c.song||''}</small>
            ${getPlayButton(name, c.song)}
          </td>
          <td>${c.votes}</td>
        </tr>`;
    });

    document.getElementById("totalVotes").innerText=totalVotes;
    updatePieChart(sorted.slice(0,5));
    document.getElementById("lastUpdate").innerHTML=
      "Atsinaujino: "+new Date().toLocaleTimeString();
  });
}

setInterval(()=>{
  timeLeft--;
  if(timeLeft<=0){
    fetchData();
    timeLeft=refreshInterval;
  }
  document.getElementById("countdown").innerHTML=
    "Atnaujinama po: "+timeLeft+" s";
},1000);

fetchData();
</script>

</body>
</html>
