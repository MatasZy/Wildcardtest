<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<title>üèÜ Balsavimo rezultatai</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#141e30,#243b55);
  color:white;
  text-align:center;
  margin:0;
  padding:20px;
}

h2{margin-bottom:5px;}

#lastUpdate,#countdown{
  font-size:14px;
  opacity:0.8;
}

.stats{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
  gap:20px;
  max-width:1100px;
  margin:30px auto;
}

.statCard{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(12px);
  padding:25px 15px;
  border-radius:15px;
  transition:0.3s;
  border:1px solid rgba(255,255,255,0.1);
}

.statCard:hover{
  transform:translateY(-6px);
  background:rgba(255,255,255,0.12);
}

.statCard.big{
  background:linear-gradient(135deg,#00c853,#4caf50);
  font-weight:bold;
}

.statNumber{
  font-size:26px;
  font-weight:bold;
  margin-bottom:6px;
}

.statLabel{
  font-size:13px;
  opacity:0.85;
  letter-spacing:0.5px;
}

table{
  width:95%;
  max-width:1100px;
  margin:auto;
  border-collapse:collapse;
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(10px);
  border-radius:10px;
  overflow:hidden;
}

th{
  background:rgba(255,255,255,0.15);
  padding:12px;
}

td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}

tr:hover{background:rgba(255,255,255,0.1);}

img{
  width:45px;
  height:45px;
  border-radius:50%;
  vertical-align:middle;
  margin-right:10px;
  object-fit:cover;
}

.nameCell{text-align:left;}

.progressBar{
  width:100%;
  height:8px;
  background:rgba(255,255,255,0.2);
  border-radius:5px;
  overflow:hidden;
  margin-bottom:4px;
}

.progressFill{
  height:100%;
  background:linear-gradient(90deg,#4cff4c,#00c853);
  transition:width 0.5s ease;
}

.firstPlace{
  background:linear-gradient(90deg,rgba(255,215,0,0.25),transparent);
}
.secondPlace{background:rgba(192,192,192,0.15);}
.thirdPlace{background:rgba(205,127,50,0.15);}

.gainUp{color:#4cff4c;font-weight:bold;}
.gainDown{color:#ff4c4c;font-weight:bold;}

canvas{
  max-width:100%;
  margin:40px auto;
}

.analytics{
  margin-top:40px;
  padding:30px;
  background:rgba(0,0,0,0.35);
  border-radius:20px;
  backdrop-filter:blur(15px);
  max-width:1100px;
  margin-left:auto;
  margin-right:auto;
}

.analyticsGrid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
  gap:25px;
}

.analyticsCard{
  background:rgba(255,255,255,0.07);
  padding:25px;
  border-radius:15px;
}

.analyticsNumber{
  font-size:28px;
  font-weight:bold;
  margin-bottom:8px;
}

.analyticsLabel{
  font-size:13px;
  opacity:0.8;
}
</style>
</head>

<body>

<h2>üèÜ Balsavimo rezultatai</h2>
<div id="lastUpdate"></div>
<div id="countdown"></div>

<div class="stats">
  <div class="statCard big">
    <div class="statNumber" id="totalVotes">0</div>
    <div class="statLabel">I≈° viso bals≈≥</div>
  </div>

  <div class="statCard">
    <div class="statNumber" id="votesPerMinute">0</div>
    <div class="statLabel">‚ö° Bals≈≥ per minutƒô</div>
  </div>

  <div class="statCard">
    <div class="statNumber" id="leaderGap">0</div>
    <div class="statLabel">ü•á Lyderio atotr≈´kis</div>
  </div>

  <div class="statCard">
    <div class="statNumber" id="fastestGrower">‚Äì</div>
    <div class="statLabel">üöÄ Greiƒçiausiai augantis</div>
  </div>
</div>

<table id="tbl"></table>

<canvas id="chart"></canvas>

<div class="analytics">
  <div class="analyticsGrid">
    <div class="analyticsCard">
      <div class="analyticsNumber" id="avgVotes">0</div>
      <div class="analyticsLabel">Vid. bals≈≥ dalyviui</div>
    </div>

    <div class="analyticsCard">
      <div class="analyticsNumber" id="topPercent">0%</div>
      <div class="analyticsLabel">Lyderio bals≈≥ dalis</div>
    </div>
  </div>
</div>

<script>
let previousVotes = {};
let refreshInterval = 5;
let timeLeft = refreshInterval;
let chart;

function fetchData(){
fetch("https://www.lrt.lt/api/v1/daily-question/2417?t="+Date.now(),{cache:"no-store"})
.then(res=>res.json())
.then(data=>{
const table=document.getElementById("tbl");
table.innerHTML=`
<tr>
<th>Dalyvis</th>
<th>Balsai</th>
<th>Pokytis</th>
<th>%</th>
<th>Skirtumas</th>
</tr>`;

let sorted=data.choices.sort((a,b)=>b.votes-a.votes);
let topVotes=sorted[0]?.votes||0;
let totalVotes=0;
let totalGain=0;
let fastestGrower={name:"‚Äì",gain:0};

sorted.forEach((c,index)=>{
  let name=(c.name || "").replace(/\/+/g,'').trim();
  let song=(c.song || "").replace(/\/+/g,'').trim();
  let oldVotes=previousVotes[name]??c.votes;
  let gain=c.votes-oldVotes;

  if(gain>fastestGrower.gain){
    fastestGrower={name:name,gain:gain};
  }

  totalGain+=gain;
  totalVotes+=c.votes;

  let diff=index===0?0:topVotes-c.votes;

  table.innerHTML+=`
  <tr class="${index===0?'firstPlace':index===1?'secondPlace':index===2?'thirdPlace':''}">
  <td class="nameCell">
  <img src="${c.image||'https://via.placeholder.com/45'}">
  <strong>${index+1}. ${name}</strong><br>
  <small>${song}</small>
  </td>
  <td>${c.votes.toLocaleString()}</td>
  <td class="${gain>=0?'gainUp':'gainDown'}">${gain>=0?'+':''}${gain}</td>
  <td>
  <div class="progressBar">
  <div class="progressFill" style="width:${c.percentage}%"></div>
  </div>
  ${c.percentage}%
  </td>
  <td>${diff.toLocaleString()}</td>
  </tr>`;

  previousVotes[name]=c.votes;
});

let votesPerMinute=Math.round((totalGain/refreshInterval)*60);
let avgVotes=Math.round(totalVotes/sorted.length);
let topPercent=((topVotes/totalVotes)*100).toFixed(1);

document.getElementById("totalVotes").innerHTML=totalVotes.toLocaleString();
document.getElementById("votesPerMinute").innerHTML=votesPerMinute.toLocaleString();
document.getElementById("leaderGap").innerHTML=
  (sorted[1]? (sorted[0].votes-sorted[1].votes).toLocaleString():0);

document.getElementById("fastestGrower").innerHTML=
  fastestGrower.gain>0 ? fastestGrower.name+" (+"+fastestGrower.gain+")":"‚Äì";

document.getElementById("avgVotes").innerHTML=avgVotes.toLocaleString();
document.getElementById("topPercent").innerHTML=topPercent+"%";

updateChart(sorted);

document.getElementById("lastUpdate").innerHTML=
"Atsinaujino: "+new Date().toLocaleTimeString();

timeLeft=refreshInterval;
});
}

function updateChart(all){
const ctx=document.getElementById('chart').getContext('2d');

let labels=all.map(c=>{
  let name=(c.name || "").replace(/\/+/g,'').trim();
  let song=(c.song || "").replace(/\/+/g,'').trim();
  return name + "\n" + song; // multi-line X a≈°yje
});

let votes=all.map(c=>c.votes);

if(chart) chart.destroy();

chart=new Chart(ctx,{
type:'bar',
data:{
labels:labels,
datasets:[{
label:'Balsai',
data:votes,
backgroundColor:'rgba(0,200,83,0.75)',
borderRadius:6,
barPercentage:0.6
}]
},
options:{
indexAxis:'x', // vertikal≈´s stulpeliai
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{display:false}},
scales:{
x:{
ticks:{color:"white", font:{size:12}},
grid:{display:false},
},
y:{
ticks:{color:"white"},
grid:{color:"rgba(255,255,255,0.1)'}
}
}
}
});
}

setInterval(()=>{
timeLeft--;
if(timeLeft<=0) fetchData();
document.getElementById("countdown").innerHTML=
"Atnaujinama po: "+timeLeft+" s";
},1000);

fetchData();
</script>

</body>
</html>
