<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<title>Balsavimo rezultatai</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #141e30, #243b55);
  color: white;
  text-align: center;
  margin: 0;
  padding: 20px;
}

h2 {
  margin-bottom: 10px;
}

#lastUpdate {
  margin-bottom: 5px;
  font-size: 14px;
  opacity: 0.8;
}

#countdown {
  font-size: 14px;
  color: #ffd700;
  margin-bottom: 15px;
}

table {
  width: 95%;
  max-width: 900px;
  margin: auto;
  border-collapse: collapse;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  border-radius: 10px;
  overflow: hidden;
}

th {
  background: rgba(255,255,255,0.15);
  padding: 12px;
}

td {
  padding: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

tr:hover {
  background: rgba(255,255,255,0.1);
}

img {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  vertical-align: middle;
  margin-right: 10px;
  object-fit: cover;
}

.nameCell {
  text-align: left;
}

.gain {
  color: #4cff4c;
  font-size: 13px;
  font-weight: bold;
}

.totalVotes {
  margin-top: 20px;
  font-size: 18px;
  font-weight: bold;
}

.firstPlace {
  background: rgba(255,215,0,0.15);
}
</style>
</head>

<body>

<h2>üèÜ Balsavimo rezultatai</h2>
<div id="lastUpdate">Atnaujinama...</div>
<div id="countdown">Atnaujinama po: 5 s</div>

<table id="tbl"></table>

<div class="totalVotes" id="totalVotes"></div>

<script>
let previousVotes = {};
let refreshInterval = 5;
let timeLeft = refreshInterval;

function fetchData() {
  fetch("https://www.lrt.lt/api/v1/daily-question/2417?t=" + new Date().getTime(), {
    cache: "no-store"
  })
  .then(res => res.json())
  .then(data => {

    const table = document.getElementById("tbl");
    const now = new Date();
    document.getElementById("lastUpdate").innerHTML =
      "Paskutinis atnaujinimas: " + now.toLocaleTimeString();

    table.innerHTML = `
      <tr>
        <th>Dalyvis</th>
        <th>Balsai</th>
        <th>Prieaugis</th>
        <th>%</th>
        <th>Skirtumas</th>
      </tr>
    `;

    let sorted = data.choices.sort((a, b) => b.votes - a.votes);
    let topVotes = sorted.length > 0 ? sorted[0].votes : 0;
    let totalVotes = 0;

    sorted.forEach((c, index) => {

      let cleanName = c.name.replace(/\/+/g, '');

      let oldVotes = previousVotes[cleanName] ?? c.votes;
      let gain = c.votes - oldVotes;

      let diff = index === 0 ? 0 : topVotes - c.votes;

      totalVotes += c.votes;

      table.innerHTML += `
        <tr class="${index === 0 ? 'firstPlace' : ''}">
          <td class="nameCell">
            <img src="${c.image || 'https://via.placeholder.com/45'}">
            <strong>${cleanName}</strong><br>
            <small>${c.song || ''}</small>
          </td>
          <td>${c.votes}</td>
          <td class="gain">+${gain}</td>
          <td>${c.percentage}%</td>
          <td>${diff}</td>
        </tr>
      `;

      previousVotes[cleanName] = c.votes;
    });

    document.getElementById("totalVotes").innerHTML =
      "I≈° viso bals≈≥: " + totalVotes;

    timeLeft = refreshInterval;
  })
  .catch(err => {
    console.error("Klaida:", err);
  });
}

// Sekund≈æi≈≥ skaitiklis
setInterval(() => {
  timeLeft--;
  if (timeLeft <= 0) {
    fetchData();
  }
  document.getElementById("countdown").innerHTML =
    "Atnaujinama po: " + timeLeft + " s";
}, 1000);

// Pirmas u≈ækrovimas
fetchData();
</script>

</body>
</html>
