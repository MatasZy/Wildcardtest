<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<title>üèÜ Balsavimo rezultatai</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#141e30,#243b55);
  color:white;
  text-align:center;
  margin:0;
  padding:20px;
}

h2{margin-bottom:5px;}

#lastUpdate,#countdown{
  font-size:14px;
  opacity:0.8;
}

.stats{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
  gap:20px;
  max-width:1000px;
  margin:30px auto;
}

.statCard{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(12px);
  padding:25px 15px;
  border-radius:15px;
  border:1px solid rgba(255,255,255,0.1);
}

.statCard.big{
  background:linear-gradient(135deg,#00c853,#4caf50);
  font-weight:bold;
}

.statNumber{
  font-size:28px;
  font-weight:bold;
  margin-bottom:8px;
}

.statLabel{
  font-size:13px;
  opacity:0.8;
}

table{
  width:95%;
  max-width:1000px;
  margin:auto;
  border-collapse:collapse;
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(10px);
  border-radius:10px;
  overflow:hidden;
}

th{
  background:rgba(255,255,255,0.15);
  padding:12px;
}

td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}

img{
  width:45px;
  height:45px;
  border-radius:50%;
  vertical-align:middle;
  margin-right:10px;
  object-fit:cover;
}

.nameCell{text-align:left;}

.progressBar{
  width:100%;
  height:8px;
  background:rgba(255,255,255,0.2);
  border-radius:5px;
  overflow:hidden;
  margin-bottom:4px;
}

.progressFill{
  height:100%;
  background:linear-gradient(90deg,#81c784,#4caf50);
}

canvas{
  max-width:1000px;
  margin:40px auto;
}
</style>
</head>

<body>

<h2>üèÜ Balsavimo rezultatai</h2>
<div id="lastUpdate"></div>
<div id="countdown"></div>

<div class="stats">
  <div class="statCard big">
    <div class="statNumber" id="totalVotes">0</div>
    <div class="statLabel">I≈° viso bals≈≥</div>
  </div>

  <div class="statCard">
    <div class="statNumber" id="votesPerMinute">0</div>
    <div class="statLabel">‚ö° Bals≈≥ per minutƒô</div>
  </div>

  <div class="statCard">
    <div class="statNumber" id="leaderGap">0</div>
    <div class="statLabel">ü•á Atotr≈´kis</div>
  </div>

  <div class="statCard">
    <div class="statNumber" id="fastestGrower">‚Äì</div>
    <div class="statLabel">üöÄ Greiƒçiausiai auga</div>
  </div>

  <div class="statCard">
    <div class="statNumber" id="leaderPercent">0%</div>
    <div class="statLabel">ü•á Lyderio dalis</div>
  </div>
</div>

<table id="tbl"></table>

<canvas id="pieChart"></canvas>
<canvas id="liveChart"></canvas>
<canvas id="scatterChart"></canvas>

<script>
Chart.register(ChartDataLabels);

let previousVotes = {};
let lastSnapshotVotes = {};
let scatterHistory = [];
let scatterChart;

let refreshInterval = 5;
let timeLeft = refreshInterval;
let pieChart;
let liveChart;

function fetchData(){
  fetch("https://www.lrt.lt/api/v1/daily-question/2417?t="+Date.now(),{cache:"no-store"})
  .then(res=>res.json())
  .then(data=>{

    const table=document.getElementById("tbl");
    table.innerHTML=`
      <tr>
        <th>Dalyvis</th>
        <th>Balsai</th>
        <th>Pokytis</th>
        <th>%</th>
        <th>Skirtumas</th>
      </tr>`;

    let sorted=data.choices.sort((a,b)=>b.votes-a.votes);
    let totalVotes=0;
    let totalGain=0;

    sorted.forEach((c,index)=>{
      let name=c.name.replace(/\/+/g,'');
      let oldVotes=previousVotes[name]??c.votes;
      let gain=c.votes-oldVotes;

      totalGain+=gain;
      totalVotes+=c.votes;

      let diff=index===0?0:sorted[0].votes-c.votes;

      table.innerHTML+=`
        <tr>
          <td class="nameCell">
            <img src="${c.image||'https://via.placeholder.com/45'}">
            <strong>${index+1}. ${name}</strong>
          </td>
          <td>${c.votes.toLocaleString()}</td>
          <td>${gain>=0?'+':''}${gain}</td>
          <td>${c.percentage}%</td>
          <td>${diff.toLocaleString()}</td>
        </tr>`;

      previousVotes[name]=c.votes;
    });

    document.getElementById("totalVotes").innerHTML=totalVotes.toLocaleString();
    document.getElementById("votesPerMinute").innerHTML=totalGain.toLocaleString();
    document.getElementById("leaderGap").innerHTML=
      sorted[1]?(sorted[0].votes-sorted[1].votes).toLocaleString():0;
    document.getElementById("leaderPercent").innerHTML=
      totalVotes?Math.round(sorted[0].votes/totalVotes*100)+"%":"0%";

    updatePieChart(sorted.slice(0,5));
    updateScatterChart(sorted);

    document.getElementById("lastUpdate").innerHTML=
      "Atnaujinta: "+new Date().toLocaleTimeString();

    timeLeft=refreshInterval;
  });
}

function updatePieChart(top5){
  const ctx=document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();

  pieChart=new Chart(ctx,{
    type:'pie',
    data:{
      labels:top5.map(c=>c.name.replace(/\/+/g,'')),
      datasets:[{
        data:top5.map(c=>c.votes),
        backgroundColor:['#F6C85F','#6FA8DC','#93C47D','#E06666','#B4A7D6']
      }]
    },
    options:{
      plugins:{
        legend:{position:'bottom'},
        datalabels:{display:false}   // <<< NUIMTI SKAIƒåIAI
      }
    }
  });
}

function updateScatterChart(sorted){
  const ctx=document.getElementById('scatterChart').getContext('2d');

  let timeLabel=new Date().toLocaleTimeString();

  sorted.forEach(c=>{
    let name=c.name.replace(/\/+/g,'');
    let last=lastSnapshotVotes[name]??c.votes;
    let gain=c.votes-last;

    scatterHistory.push({
      name:name,
      time:timeLabel,
      gain:gain
    });

    lastSnapshotVotes[name]=c.votes;
  });

  if(scatterChart) scatterChart.destroy();

  let datasets=[];

  let participants=[...new Set(scatterHistory.map(s=>s.name))];

  participants.forEach(name=>{
    datasets.push({
      label:name,
      data:scatterHistory
        .filter(s=>s.name===name)
        .map((s,i)=>({x:i,y:s.gain})),
      showLine:false,
      pointRadius:6
    });
  });

  scatterChart=new Chart(ctx,{
    type:'scatter',
    data:{datasets:datasets},
    options:{
      scales:{
        x:{title:{display:true,text:"Atnaujinimai (kas 5s)"}},
        y:{beginAtZero:true,title:{display:true,text:"Bals≈≥ prieaugis"}}
      },
      plugins:{
        legend:{position:'bottom'},
        datalabels:{
          align:'top',
          color:'#ffffff',
          formatter:(value)=>value.y>0?value.y:''
        }
      }
    }
  });
}

setInterval(()=>{
  timeLeft--;
  if(timeLeft<=0) fetchData();
  document.getElementById("countdown").innerHTML=
    "Atnaujinama po: "+timeLeft+" s";
},1000);

fetchData();
</script>

</body>
</html>
